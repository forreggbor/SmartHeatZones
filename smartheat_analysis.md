# SmartHeatZones Integr√°ci√≥ - Teljes M≈±k√∂d√©si Elemz√©s

## 1. √ÅLTAL√ÅNOS √ÅTTEKINT√âS

### C√©l
T√∂bbz√≥n√°s intelligens f≈±t√©svez√©rl√©s Home Assistant-ban, ahol minden z√≥na √∂n√°ll√≥an kezelhet≈ë termoszt√°t, de egy k√∂z√∂s kaz√°n f≈ëkapcsol√≥n osztoznak.

### Verzi√≥
1.4.2 (2025.10+ HA verzi√≥hoz optimaliz√°lva)

### Fejleszt√©si √Ållapot
‚ö†Ô∏è **Akt√≠v fejleszt√©s alatt, hib√°kat tartalmaz, NEM aj√°nlott √©les k√∂rnyezetben!**

---

## 2. ARCHITEKT√öRA

### F≈ë Komponensek

```
SmartHeatZones Integr√°ci√≥
‚îú‚îÄ‚îÄ Config Flow (config_flow.py)
‚îÇ   ‚îú‚îÄ‚îÄ Z√≥na l√©trehoz√°s
‚îÇ   ‚îî‚îÄ‚îÄ Options Flow (be√°ll√≠t√°sok)
‚îú‚îÄ‚îÄ Climate Platform (climate.py)
‚îÇ   ‚îú‚îÄ‚îÄ Z√≥n√°nk√©nt 1 climate entit√°s
‚îÇ   ‚îî‚îÄ‚îÄ Termoszt√°t logika
‚îú‚îÄ‚îÄ BoilerManager (__init__.py)
‚îÇ   ‚îú‚îÄ‚îÄ Akt√≠v z√≥n√°k nyilv√°ntart√°sa
‚îÇ   ‚îî‚îÄ‚îÄ Kaz√°n f≈ëkapcsol√≥ vez√©rl√©s
‚îî‚îÄ‚îÄ Konstansok (const.py)
    ‚îî‚îÄ‚îÄ Konfigur√°ci√≥ kulcsok
```

### Entit√°s Strukt√∫ra

**Minden z√≥na l√©trehoz:**
- `climate.<z√≥na_n√©v>` entit√°st
  - M√≥dok: `heat`, `off`
  - Jellemz≈ëk: `target_temperature` be√°ll√≠that√≥
  - √Ållapot: aktu√°lis h≈ëm√©rs√©klet (szenzorb√≥l)

---

## 3. M≈∞K√ñD√âSI LOGIKA

### 3.1 Z√≥na Vez√©rl√©s (Climate Entity)

#### Hiszter√©zises Termoszt√°t Logika

```python
# Pszeudok√≥d
current_temp = h≈ëm√©rs√©klet_szenzor.√°llapot
target_temp = felhaszn√°l√≥_√°ltal_be√°ll√≠tott_c√©l
hysteresis = 0.3  # alap√©rtelmezett

# F≈±t√©s sz√ºks√©ges?
if current_temp + (hysteresis / 2) < target_temp:
    ‚Üí Z√≥na √°llapot: AKT√çV (f≈±t√©s kell)
    ‚Üí Z√≥na rel√©k: BE kapcsol√°s
    ‚Üí Z√≥na regisztr√°ci√≥: akt√≠v z√≥n√°k halmaz√°ba
    
# T√∫l meleg?
elif current_temp - (hysteresis / 2) >= target_temp:
    ‚Üí Z√≥na √°llapot: INAKT√çV
    ‚Üí Z√≥na rel√©k: KI kapcsol√°s
    ‚Üí Z√≥na t√∂rl√©s: akt√≠v z√≥n√°k halmaz√°b√≥l
    
# Hiszter√©zis s√°vban (nincs v√°ltoz√°s)
else:
    ‚Üí Tartja a jelenlegi √°llapotot
```

**P√©lda:**
- C√©l: 22¬∞C, Hiszter√©zis: 0.3¬∞C
- Bekapcsol ha: aktu√°lis < 21.85¬∞C
- Kikapcsol ha: aktu√°lis ‚â• 22.15¬∞C
- 21.85 - 22.15 k√∂z√∂tt: nincs v√°ltoz√°s

#### Ajt√≥/Ablak Tilt√°s

```python
if any(ajt√≥_ablak_szenzor.√°llapot == "on"):  # nyitva
    ‚Üí Z√≥na rel√©k: KI (m√©g ha f≈±t√©s kellene is)
    ‚Üí Kaz√°n: lehet hogy fut m√°s z√≥na miatt
```

### 3.2 Kaz√°n F≈ëkapcsol√≥ Menedzsment (BoilerManager)

**Glob√°lis Koordin√°ci√≥:**

```python
# __init__.py - BoilerManager oszt√°ly
DATA_ACTIVE_ZONES = "active_zones"  # set t√≠pus
DATA_BOILER_MAIN = "boiler_main_entity_id"

# Amikor z√≥na akt√≠vv√° v√°lik:
hass.data[DOMAIN][DATA_ACTIVE_ZONES].add(zone_id)
‚Üí ellen≈ëriz_√©s_kapcsol_kaz√°nt()

# Amikor z√≥na inakt√≠vv√° v√°lik:
hass.data[DOMAIN][DATA_ACTIVE_ZONES].remove(zone_id)
‚Üí ellen≈ëriz_√©s_kapcsol_kaz√°nt()

def ellen≈ëriz_√©s_kapcsol_kaz√°nt():
    if len(active_zones) > 0:
        switch.turn_on(boiler_main_relay)
    else:
        switch.turn_off(boiler_main_relay)
```

**Fontos:** A kaz√°n f≈ëkapcsol√≥ NEM k√ºl√∂n entit√°s, hanem egy megl√©v≈ë `switch.*` entit√°s, amit az integr√°ci√≥ vez√©rel.

### 3.3 Id≈ëz√≠t√©s (Schedule)

**1-4 Napszak Defini√°lhat√≥:**

```yaml
# P√©lda konfigur√°ci√≥
schedule:
  - start: "06:00"
    end: "08:00"
    temp: 22.0  # Reggel komfort
  - start: "08:00"
    end: "16:00"
    temp: 18.0  # Napk√∂zben eco
  - start: "16:00"
    end: "22:00"
    temp: 22.0  # Este komfort
  - start: "22:00"
    end: "06:00"
    temp: 16.0  # √âjszaka alacsony
```

**M≈±k√∂d√©s:**
- HA indul√°skor: aktu√°lis id≈ëblokk keres√©se ‚Üí `target_temp` be√°ll√≠t√°sa
- Opci√≥k m√≥dos√≠t√°sakor: √∫jra√©rt√©kel√©s
- **HI√ÅNYZIK:** Automatikus √°tv√°lt√°s napszakok k√∂z√∂tt fut√°s k√∂zben

### 3.4 K√©zi Fel√ºl√≠r√°s Lovelace-b≈ël

**Termoszt√°t K√°rtya Logika:**

```python
# Amikor felhaszn√°l√≥ v√°ltoztat target_temp-en:

if new_target > current_temp AND hvac_mode == OFF:
    ‚Üí hvac_mode = HEAT  # Auto bekapcsol
    
if new_target < current_temp AND hvac_mode == HEAT:
    ‚Üí hvac_mode = OFF  # Auto kikapcsol
```

**C√©l:** Intuit√≠v kezel√©s - ha melegebbre √°ll√≠tasz ‚Üí f≈±t, ha hidegebbre ‚Üí nem f≈±t.

---

## 4. KONFIGUR√ÅCI√ì

### 4.1 Config Flow (Z√≥na L√©trehoz√°s)

```python
# config_flow.py
L√©p√©s 1: Z√≥na n√©v megad√°sa
  ‚Üí L√©trej√∂n: climate.<zone_name>

# Kezdeti minim√°lis adatok:
{
    "name": "F√∂ldszint",
    "sensor": None,  # k√©s≈ëbb Options-ban
    "zone_relays": [],
    "boiler_main": None,
    ...
}
```

### 4.2 Options Flow (Be√°ll√≠t√°sok)

**Szerkeszthet≈ë Param√©terek:**

| Param√©ter | T√≠pus | Le√≠r√°s |
|-----------|-------|--------|
| `sensor` | entity_selector (sensor) | H≈ëm√©rs√©klet szenzor |
| `boiler_main` | entity_selector (switch) | K√∂z√∂s kaz√°n f≈ëkapcsol√≥ |
| `zone_relays` | entity_selector (switch, multiple) | Z√≥na rel√©k (1 vagy t√∂bb) |
| `door_sensors` | entity_selector (binary_sensor, multiple) | Ajt√≥/ablak szenzor (opcion√°lis) |
| `hysteresis` | number (0.1-2.0) | Hiszter√©zis ¬∞C-ban |
| `active_blocks` | number (1-4) | Akt√≠v id≈ëblokkok sz√°ma |
| `schedule[0-3]` | Blokkonk√©nt: start, end, temp | Napszak defin√≠ci√≥k |

**√ârt√©k Perzisztencia:**
- Utols√≥ mentett √©rt√©kek automatikusan visszat√∂lt≈ëdnek √∫jranyit√°skor
- Default √©rt√©kek: `const.py` ‚Üí `DEFAULT_*`

---

## 5. K√ìDSTRUKT√öRA

### F√°jlok √©s Felel≈ëss√©gek

```
custom_components/smartheatzones/
‚îÇ
‚îú‚îÄ‚îÄ manifest.json          # Integr√°ci√≥ metaadatok
‚îÇ   ‚îî‚îÄ‚îÄ domain: "smartheatzones"
‚îÇ   ‚îî‚îÄ‚îÄ config_flow: true
‚îÇ   ‚îî‚îÄ‚îÄ version: "1.4.2"
‚îÇ   ‚îî‚îÄ‚îÄ iot_class: "local_polling"
‚îÇ
‚îú‚îÄ‚îÄ __init__.py            # Entry point + BoilerManager
‚îÇ   ‚îú‚îÄ‚îÄ async_setup_entry()
‚îÇ   ‚îú‚îÄ‚îÄ BoilerManager oszt√°ly
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ register_zone_activity()
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ unregister_zone_activity()
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update_boiler_state()
‚îÇ   ‚îî‚îÄ‚îÄ hass.data[DOMAIN] inicializ√°l√°s
‚îÇ
‚îú‚îÄ‚îÄ config_flow.py         # UI konfigur√°ci√≥s flow
‚îÇ   ‚îú‚îÄ‚îÄ SmartHeatZonesConfigFlow
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ async_step_user()  # Z√≥na l√©trehoz√°s
‚îÇ   ‚îî‚îÄ‚îÄ SmartHeatZonesOptionsFlow
‚îÇ       ‚îî‚îÄ‚îÄ async_step_init()  # Be√°ll√≠t√°sok szerkeszt√©s
‚îÇ
‚îú‚îÄ‚îÄ climate.py             # Climate platform implement√°ci√≥
‚îÇ   ‚îú‚îÄ‚îÄ SmartHeatZoneClimate(ClimateEntity)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ async_set_temperature()
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ async_set_hvac_mode()
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _async_control_heating()  # Hiszter√©zis logika
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ _async_sensor_changed()   # Szenzor callback
‚îÇ   ‚îî‚îÄ‚îÄ Termoszt√°t jellemz≈ëk
‚îÇ
‚îú‚îÄ‚îÄ const.py               # Konstansok
‚îÇ   ‚îú‚îÄ‚îÄ DOMAIN = "smartheatzones"
‚îÇ   ‚îú‚îÄ‚îÄ CONF_* kulcsok (sensor, relays, ...)
‚îÇ   ‚îú‚îÄ‚îÄ DATA_* kulcsok (active_zones, boiler_main)
‚îÇ   ‚îî‚îÄ‚îÄ DEFAULT_* √©rt√©kek
‚îÇ
‚îî‚îÄ‚îÄ translations/
    ‚îú‚îÄ‚îÄ en.json            # Angol ford√≠t√°sok
    ‚îî‚îÄ‚îÄ hu.json            # Magyar ford√≠t√°sok (ha van)
```

---

## 6. AZONOS√çTOTT PROBL√âM√ÅK (K√ìD ELEMZ√âS ALAPJ√ÅN)

### ‚úÖ J√ì H√çREK
A k√≥d alapvet≈ëen **J√ìL VAN IMPLEMENT√ÅLVA**! A hiszter√©zis logika, rel√© kapcsol√°s √©s kaz√°n menedzsment mind megvan.

### ‚ö†Ô∏è VAL√ìS PROBL√âM√ÅK

#### 1. **Rel√© Kapcsol√°s Val√≥sz√≠n≈± Oka: Inicializ√°l√°si Probl√©ma**

**MEGTAL√ÅLTAM!** A `climate.py` 115-116. sor√°ban:
```python
async def async_set_temperature(self, **kwargs: Any) -> None:
    """C√©lh≈ëm√©rs√©klet be√°ll√≠t√°sa."""
    temp = kwargs.get(ATTR_TEMPERATURE)
    if temp is None:
        return
    self._target_temp = float(temp)
    _LOGGER.info("%s [%s] Target temperature set to %.1f¬∞C", LOG_PREFIX, self.name, self._target_temp)
    await self._evaluate_heating()  # ‚Üê EZ MEGVAN!
    self.async_write_ha_state()
```

**A k√≥d helyes!** De a probl√©ma m√°shol van:

**VAL√ìDI OK:**
```python
# climate.py 69. sor - async_setup_entry()
sensor = data.get(CONF_SENSOR)  # ‚Üê Options-b√≥l j√∂n
relays = data.get(CONF_ZONE_RELAYS, [])
boiler_entity = data.get(CONF_BOILER_MAIN)
```

**A CONFIG FLOW-BAN** (config_flow.py 46. sor) a z√≥na l√©trehoz√°sakor:
```python
return self.async_create_entry(title=title, data=self._data)
#                                            ^^^^^^^^^^^^
# Ez a 'data'-ba megy, DE az Options-ban 'options'-ba mentesz!
```

**PROBL√âMA:** 
- ConfigFlow: **`data`**-ba ment
- OptionsFlow: **`options`**-ba ment  
- Climate.py: **csak** `entry.options`-b√≥l olvas (69. sor)

Ha nem nyitottad meg az Options-t √©s nem mentetted, akkor a `sensor`, `relays`, `boiler` mind **`None` vagy √ºres lista**!

**BIZONY√çT√âK:**
```python
# climate.py 102. sor
async def _evaluate_heating(self):
    if self._hvac_mode == HVACMode.OFF:
        return  # ‚Üê Ha OFF m√≥dban vagy, NEM kapcsol!
```

√âs a 79. sorban:
```python
self._hvac_mode = HVACMode.OFF  # ‚Üê Kezd≈ë√°llapot mindig OFF!
```

#### 2. **Ford√≠t√°sok Nem Jelennek Meg**
**Lehets√©ges okok:**

```python
# A) translations/hu.json hi√°nyzik vagy rossz helyen van
# B) manifest.json-ban nincs:
{
    "config_flow": true,
    "translation_key": "smartheatzones"  # ‚Üê LEHET HOGY HI√ÅNYZIK
}

# C) strings.json vs translations/ strukt√∫ra kevered√©s
# R√©gi: strings.json
# √öj HA: translations/en.json, translations/hu.json
```

#### 3. **Napszak Automatikus V√°lt√°s Hi√°nyzik**
- Nincs `async_track_time_interval()` vagy hasonl√≥
- Csak indul√°sn√°l √©s options v√°ltoz√°sn√°l √©rt√©kel

### üêõ EGY√âB HIB√ÅK

#### 4. **Kaz√°n F≈ëkapcsol√≥ Szinkroniz√°ci√≥**
- Ha k√ºl√∂nb√∂z≈ë z√≥n√°k k√ºl√∂nb√∂z≈ë kaz√°n rel√©t v√°lasztanak ‚Üí konfliktus
- Nincs valid√°ci√≥ vagy figyelmeztet√©s

#### 5. **Hiba√°ll√≠t√°s Kezel√©s**
- Mi van ha szenzor `unavailable` vagy `unknown`?
- Mi van ha switch nem v√°laszol?

#### 6. **State Restoration**
- √öjraind√≠t√°s ut√°n vissza√°ll-e a target_temp √©s hvac_mode?

---

## 7. M≈∞K√ñD√âSI FOLYAMAT P√âLDA

### Scenario: F√∂ldszint Z√≥na F≈±t√©se

```
1. INDUL√ÅS
   ‚îú‚îÄ‚îÄ HA bet√∂lti smartheatzones integr√°ci√≥t
   ‚îú‚îÄ‚îÄ __init__.py: BoilerManager l√©trej√∂n
   ‚îú‚îÄ‚îÄ climate.py: climate.foldszint entit√°s l√©trej√∂n
   ‚îî‚îÄ‚îÄ Kezd≈ë√°llapot:
       ‚îú‚îÄ‚îÄ current_temp: 19.5¬∞C (szenzorb√≥l)
       ‚îú‚îÄ‚îÄ target_temp: 22.0¬∞C (schedule-b√≥l)
       ‚îú‚îÄ‚îÄ hvac_mode: off
       ‚îî‚îÄ‚îÄ Z√≥na rel√©k: KI

2. FELHASZN√ÅL√ì M√ìDOS√çT
   ‚îú‚îÄ‚îÄ Thermostat k√°rty√°n: target_temp = 23.0¬∞C
   ‚îú‚îÄ‚îÄ climate.async_set_temperature() h√≠v√≥dik
   ‚îî‚îÄ‚îÄ ‚ùå HIBA: Nincs vez√©rl√©s megh√≠vva!
   
   # K√âNEllen≈ërizni kell:
   ‚îî‚îÄ‚îÄ ‚úì Kellene:
       ‚îú‚îÄ‚îÄ Auto v√°lt√°s HEAT m√≥dba (23 > 19.5)
       ‚îú‚îÄ‚îÄ _async_control_heating() megh√≠v√°s
       ‚îú‚îÄ‚îÄ Hiszter√©zis ellen≈ërz√©s: 19.5 < 23 - 0.15 ‚Üí IGEN
       ‚îú‚îÄ‚îÄ Zone relays: BE kapcsol√°s
       ‚îú‚îÄ‚îÄ BoilerManager.register_zone_activity("foldszint")
       ‚îî‚îÄ‚îÄ Kaz√°n f≈ëkapcsol√≥: BE

3. H≈êM√âRS√âKLET EMELKEDIK
   ‚îú‚îÄ‚îÄ Szenzor: 19.5 ‚Üí 20.0 ‚Üí ... ‚Üí 22.8 ‚Üí 23.0 ‚Üí 23.2¬∞C
   ‚îú‚îÄ‚îÄ _async_sensor_changed() callback minden v√°ltoz√°sn√°l
   ‚îú‚îÄ‚îÄ Hiszter√©zis ellen≈ërz√©s folyamatos:
   ‚îÇ   ‚îú‚îÄ‚îÄ 22.8 < 23.15 ‚Üí Tov√°bbra f≈±t
   ‚îÇ   ‚îî‚îÄ‚îÄ 23.2 >= 23.15 ‚Üí KIKAPCSOL
   ‚îú‚îÄ‚îÄ Zone relays: KI
   ‚îú‚îÄ‚îÄ BoilerManager.unregister_zone_activity("foldszint")
   ‚îî‚îÄ‚îÄ Ha nincs m√°s akt√≠v z√≥na ‚Üí Kaz√°n: KI

4. AJT√ì NYIT√ÅS
   ‚îú‚îÄ‚îÄ binary_sensor.ajto = "on"
   ‚îú‚îÄ‚îÄ Z√≥na detekt√°lja
   ‚îú‚îÄ‚îÄ Azonnal: Zone relays KI
   ‚îî‚îÄ‚îÄ BoilerManager: Z√≥na inakt√≠v (√°tmeneti lockout)
```

---

## 8. AJ√ÅNLOTT FEJLESZT√âSEK PRIORIZ√ÅLVA

### üî¥ AZONNAL (Kritikus Jav√≠t√°sok)

1. **Rel√© Kapcsol√°s Implement√°l√°s**
   - `async_set_temperature()` ‚Üí `_async_control_heating()` h√≠v√°s
   - `async_set_hvac_mode()` ‚Üí `_async_control_heating()` h√≠v√°s
   - `_async_control_heating()` teljes implement√°ci√≥

2. **Ford√≠t√°sok Jav√≠t√°s**
   - `translations/hu.json` l√©trehoz√°sa
   - `manifest.json` ellen≈ërz√©s
   - Kulcsok egyeztet√©se

3. **Alapvet≈ë Tesztel√©s**
   - Debug logol√°s minden l√©p√©sn√©l
   - Hiba√°ll√≠t√°sok kezel√©se

### üü° HAMAROSAN (M≈±k√∂d√©si Jav√≠t√°sok)

4. **Napszak Auto V√°lt√°s**
   - `async_track_time_change()` haszn√°lata
   - √ìr√°nk√©nt ellen≈ërz√©s + target_temp friss√≠t√©s

5. **State Restoration**
   - `RestoreEntity` mixin haszn√°lata
   - √öjraind√≠t√°s ut√°n √°llapot vissza√°ll√≠t√°s

6. **Kaz√°n Szinkron Valid√°ci√≥**
   - Options ment√©skor ellen≈ërz√©s
   - Figyelmeztet√©s ha k√ºl√∂nb√∂z≈ë kaz√°n v√°lasztva

### üü¢ K√âS≈êBB (Extra Funkci√≥k)

7. **PV Integr√°ci√≥**
   - Napelem sensor figyel√©se
   - F≈±t√©s enged√©lyez√©s t√∂bblet energia eset√©n
   - Dinamikus target_temp boost

8. **Adapt√≠v Vez√©rl√©s**
   - Tanul√°s: felf≈±t√©si id≈ë, t√∫ll√∂v√©s
   - Predikt√≠v ind√≠t√°s

9. **Dashboard & Monitoring**
   - √ñsszefoglal√≥ k√°rtya
   - Energiafogyaszt√°s tracking

---

## 9. DEBUG LOGOL√ÅS

### Javasolt configuration.yaml

```yaml
logger:
  default: info
  logs:
    custom_components.smartheatzones: debug
    custom_components.smartheatzones.climate: debug
    custom_components.smartheatzones.config_flow: debug
```

### Logokban Keresend≈ë

```python
# Sikeres inicializ√°l√°s
"SmartHeatZones domain data initialized"
"BoilerManager created"
"Climate entity climate.foldszint created"

# Szenzor friss√≠t√©s
"Sensor update: sensor.temp_foldszint = 19.5"
"Evaluating heating control"

# Rel√© kapcsol√°s
"Turning ON zone relays: [switch.rele1, switch.rele2]"
"Registering zone 'foldszint' as active"
"Boiler main relay switch.kazan_fo: turning ON"

# Hib√°k
"ERROR: Failed to call service switch.turn_on"
"WARNING: Temperature sensor unavailable"
```

---

## 10. √ñSSZEFOGLAL√ÅS

### ‚úÖ MI M≈∞K√ñDIK
- Config Flow: z√≥n√°k l√©trehoz√°sa ‚úì
- Options Flow: be√°ll√≠t√°sok UI ‚úì
- Climate entit√°s megjelenik ‚úì
- Szenzor beolvas√°s ‚úì
- Hiszter√©zis logika (elvileg) ‚úì

### ‚ùå MI NEM M≈∞K√ñDIK
- **Rel√©k NEM kapcsolnak** (kritikus!)
- **Ford√≠t√°sok nem jelennek meg**
- Napszak auto v√°lt√°s hi√°nyzik
- Nincs state restoration

### üéØ K√ñVETKEZ≈ê L√âP√âSEK

1. **K√≥d let√∂lt√©se √©s √°ttekint√©se:**
   - `climate.py` teljes elemz√©se
   - `__init__.py` BoilerManager ellen≈ërz√©s

2. **Debug session:**
   - Log szint debug-ra
   - Manu√°lis tesztel√©s k√°rty√°b√≥l
   - Logok elemz√©se

3. **Kritikus jav√≠t√°sok implement√°l√°sa**
   - Rel√© kapcsol√°s m≈±k√∂d≈ëk√©pess√© t√©tele
   - Ford√≠t√°sok helyre√°ll√≠t√°sa

---

**Verzi√≥:** Elemz√©s v1.0 - 2025-10-26  
**Alapul v√©ve:** SmartHeatZones v1.4.2 README